name: "Auto Create PR"

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Wait for GitHub to sync
        run: sleep 15

      - name: Check and create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH_NAME"
          
          git fetch origin main --quiet
          
          PENDING_COMMITS=$(git log origin/main..HEAD --oneline 2>/dev/null | wc -l)
          
          if [ "$PENDING_COMMITS" -eq 0 ]; then
            echo "No pending commits"
            exit 0
          fi
          
          echo "Found $PENDING_COMMITS pending commit(s)"
          
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --base main --state open --json number --jq '.[0].number')
          
          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "PR #$EXISTING_PR already exists"
            exit 0
          fi
          
          COMMIT_MSG=$(git log -1 --pretty=%s)
          ALL_COMMITS=$(git log origin/main..HEAD --pretty=format:'- %h %s' | head -10)
          
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "$COMMIT_MSG" \
            --body "## Auto-generated PR

          This PR was automatically created from branch \`$BRANCH_NAME\`.

          ### Commits ($PENDING_COMMITS total)
          $ALL_COMMITS" || echo "PR creation failed or already exists"
