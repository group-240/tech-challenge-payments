name: "Auto Create PR"

on:
  workflow_run:
    workflows: ["CI/CD Payments Service"]
    types:
      - completed
    branches-ignore:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch != 'main' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Check and create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
          echo "Branch: $BRANCH_NAME"
          echo "Deploy workflow finished successfully, checking for PR..."
          
          git fetch origin main --quiet
          
          PENDING_COMMITS=$(git log origin/main..HEAD --oneline 2>/dev/null | wc -l)
          
          if [ "$PENDING_COMMITS" -eq 0 ]; then
            echo "No pending commits"
            exit 0
          fi
          
          echo "Found $PENDING_COMMITS pending commit(s)"
          
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --base main --state open --json number --jq '.[0].number')
          
          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "PR #$EXISTING_PR already exists"
            exit 0
          fi
          
          COMMIT_MSG=$(git log -1 --pretty=%s)
          ALL_COMMITS=$(git log origin/main..HEAD --pretty=format:'- %h %s' | head -10)
          
          echo "Creating PR..."
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "$COMMIT_MSG" \
            --body "## Auto-generated PR

          This PR was automatically created after successful CI/CD.

          **Branch:** \`$BRANCH_NAME\`
          **Commits:** $PENDING_COMMITS

          $ALL_COMMITS" || echo "PR creation failed or already exists"
